```erlang
rr(jose_jwk).
JWK = #jose_jwk{} = jose_jwk:from_key(EncryptionKey).   % extra match avoids binding to {error,enoent}
jose_jwk:block_encrypt(Plaintext, JWK).  % uses the default JWE options; if you pass an empty map, _then_ it errors.
```

```
 call public_key:encrypt_public(<<141,171,231,154,48,63,46,188,74,75,135,5,231,135,79,135>>,{'RSAPublicKey',22960999940703944182956838265544719686397201910696485151082701686216457234146462646746151496302648562884538815129144037390980391930620468665084844248022557115802334972251010562262609554413388093717732091032817711148057359187485435530758346935946187922644513149459260887915634648092413986753260050773437282917783221646640070565121356903908321828855617755128784824772846093118685557137396642910264036467146649383020362615305496752852699868692979327465516984323518203672557032821348497824201587129613821088236019157234939667535531863194858847231325604196000464397016789471932051682398985978524584995732538867140739862127,
                65537},[{rsa_padding,rsa_pkcs1_oaep_padding}])
```

So what we've got there is a short binary, <<141,171,231,154,48,63,46,188,74,75,135,5,231,135,79,135>> -- 16 bytes, being encrypted with the public key.

We must then be doing some other crypto.

Also, where did that binary come from? I assume crypto:strong_rand_bytes.

```
29>
29> jose_jwk:block_encrypt(<<"Hello World">>, JWK).
(<0.1155.0>) call crypto:strong_rand_bytes(16)
(<0.1155.0>) call crypto:strong_rand_bytes(12)
(<0.1155.0>) call public_key:encrypt_public(<<67,201,42,232,137,171,105,110,53,14,127,216,34,141,71,145>>,{'RSAPublicKey',22960999940703944182956838265544719686397201910696485151082701686216457234146462646746151496302648562884538815129144037390980391930620468665084844248022557115802334972251010562262609554413388093717732091032817711148057359187485435530758346935946187922644513149459260887915634648092413986753260050773437282917783221646640070565121356903908321828855617755128784824772846093118685557137396642910264036467146649383020362615305496752852699868692979327465516984323518203672557032821348497824201587129613821088236019157234939667535531863194858847231325604196000464397016789471932051682398985978524584995732538867140739862127,
                65537},[{rsa_padding,rsa_pkcs1_oaep_padding}])
(<0.1155.0>) call crypto:public_encrypt(rsa,<<67,201,42,232,137,171,105,110,53,14,127,216,34,141,71,145>>,[65537,
 22960999940703944182956838265544719686397201910696485151082701686216457234146462646746151496302648562884538815129144037390980391930620468665084844248022557115802334972251010562262609554413388093717732091032817711148057359187485435530758346935946187922644513149459260887915634648092413986753260050773437282917783221646640070565121356903908321828855617755128784824772846093118685557137396642910264036467146649383020362615305496752852699868692979327465516984323518203672557032821348497824201587129613821088236019157234939667535531863194858847231325604196000464397016789471932051682398985978524584995732538867140739862127],[{rsa_padding,rsa_pkcs1_oaep_padding}])
(<0.1155.0>) call crypto:crypto_one_time_aead(aes_gcm,<<67,201,42,232,137,171,105,110,53,14,127,216,34,141,71,145>>,<<25,24,254,183,50,215,17,21,24,196,220,107>>,<<"Hello World">>,<<"eyJhbGciOiJSU0EtT0FFUCIsImVuYyI6IkExMjhHQ00ifQ">>,true)
{#{alg => jose_jwe_alg_rsa,enc => jose_jwe_enc_aes},
 #{<<"ciphertext">> => <<"gDmJRLj4nbQk6Sk">>,
   <<"encrypted_key">> =>
       <<"gzhrO1mnMbTzUzLjhmBbx_i5WcGEFourgzyiDvjIWzKWZPdFFPtWfgrQGoeXRuPdqVGII0Y3_-wcrpGMRFNrrShQI9E9cNpRkH5eDkTS"...>>,
   <<"iv">> => <<"GRj-tzLXERUYxNxr">>,
   <<"protected">> =>
       <<"eyJhbGciOiJSU0EtT0FFUCIsImVuYyI6IkExMjhHQ00ifQ">>,
   <<"tag">> => <<"UQK8VPAxh4Bm2oj7ocfIcw">>}}
```


```erlang
EncryptionJWK = jose_jwk:from_pem_file("keys/jwe-napoleon-encryption.key").
jose_jwk:block_encrypt(<<"Hello World">>, #{<<"alg">> => <<"RSA-OAEP">>, <<"enc">> => <<"A128CBC-HS256">>}, EncryptionJWK).
```

```
(<0.121.0>) call crypto:strong_rand_bytes(32)     -- CEK
(<0.121.0>) call crypto:strong_rand_bytes(16)     -- IV

(<0.121.0>) call public_key:encrypt_public(<<197,93,57,235,19,155,222,42,108,155,76,0,148,126,240,198,62,26,182,235,55,
  161,92,125,228,179,237,195,20,96,57,166>>,{'RSAPublicKey',17997438139562364458908909538252250997483063449796566181627357266406918000371626570862148865824486721098292175657509287160973905171952364459914045146284645577579574288224689379199853400447070790089367654472234912625692982939629517648576568969959768202241757624234950177893250816746897581193890628925794499441635009995975557894952430757092158249206295247738416720517648293217426541334126199822270697874062259805615655079965874295704419382445261869503173990207978975516762459993138036861097829979813137466624985084816610872895705411387064993877294936564267197209507280702835174521680843039444738699369000994487741123999,
                65537},[{rsa_padding,rsa_pkcs1_oaep_padding}])
(<0.121.0>) call crypto:public_encrypt(rsa,<<197,93,57,235,19,155,222,42,108,155,76,0,148,126,240,198,62,26,182,235,55,
  161,92,125,228,179,237,195,20,96,57,166>>,[65537,
 17997438139562364458908909538252250997483063449796566181627357266406918000371626570862148865824486721098292175657509287160973905171952364459914045146284645577579574288224689379199853400447070790089367654472234912625692982939629517648576568969959768202241757624234950177893250816746897581193890628925794499441635009995975557894952430757092158249206295247738416720517648293217426541334126199822270697874062259805615655079965874295704419382445261869503173990207978975516762459993138036861097829979813137466624985084816610872895705411387064993877294936564267197209507280702835174521680843039444738699369000994487741123999],[{rsa_padding,rsa_pkcs1_oaep_padding}]) -- public_key calls crypto

(<0.121.0>) call crypto:crypto_one_time(aes_cbc,  -- CipherAlgo
<<62,26,182,235,55,161,92,125,228,179,237,195,20,96,57,166>>, -- CEK
<<250,107,66,86,243,249,231,103,197,143,102,121,98,159,255,69>>,  -- IV
<<72,101,108,108,111,32,87,111,114,108,100,5,5,5,5,5>>, -- Data, padded; who padded it? -- jose_jwa_pkcs7:pad(Data)
true) -- encrypt; *not* crypto_one_time_aead

(<0.121.0>) call crypto:mac(hmac,sha256,<<197,93,57,235,19,155,222,42,108,155,76,0,148,126,240,198>>,<<101,121,74,104,98,71,99,105,79,105,74,83,85,48,69,116,84,48,70,70,85,67,73,
  115,73,109,86,117,89,121,73,54,73,107,69,120,77,106,104,68,81,107,77,116,83,
  70,77,121,78,84,89,105,102,81,250,107,66,86,243,249,231,103,197,143,102,121,
  98,159,255,69,65,221,179,28,197,89,127,84,23,208,31,36,149,43,28,217,0,0,0,0,
  0,0,1,176>>)
```

```erlang
dbg:start().
dbg:tracer().
dbg:tp(public_key, '_', []).
dbg:tp(crypto, '_', []).
dbg:p(all, c).
```





Or we can mess around with Erlang directly (TODO).

Then we can write it to a file:




```sh
```

Let's try it this way


TODO:



- Erlang: JWE decryption w/o JOSE.
- Does jose_jwt compact the JWS? Doesn't look like it. How can I get it to compact the JWS before encryption? Am I stuck
  with using the slightly lower-level functions?

This appears to encrypt the JSON-serialized thing, but that's not making much sense, either:

```
JWE = jose_jwt:encrypt(EncryptionJWK, #{<<"alg">> => <<"RSA-OAEP">>, <<"enc">> => <<"A128GCM">>}, JWS).
```
