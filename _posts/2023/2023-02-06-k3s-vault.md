---
title: "Installing Hashicorp Vault"
date: 2023-02-06T18:57:00Z
tags: k3s kubernetes
layout: series
series: k3s
---

A discussion came up at work about using the [External Secrets Operator](https://external-secrets.io/v0.7.2/) with AWS
Secrets Manager. Since I'm running a homelab, I'll use [Hashicorp Vault](https://www.vaultproject.io/) instead.

I'm broadly following [this tutorial](https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-minikube-raft),
but with only a single vault node (so no HA, no Raft).

Vault can be [installed using Helm](https://developer.hashicorp.com/vault/docs/platform/k8s/helm):

```sh
helm repo add hashicorp https://helm.releases.hashicorp.com
helm install vault hashicorp/vault --namespace vault --create-namespace
```

Then it must be initialized and unsealed:

```sh
kubectl --namespace vault exec vault-0 -- vault operator init \
    -key-shares=1 \
    -key-threshold=1 \
    -format=json > cluster-keys.json
VAULT_UNSEAL_KEY=$(jq -r ".unseal_keys_b64[]" cluster-keys.json)
kubectl --namespace exec vault-0 -- vault operator unseal $VAULT_UNSEAL_KEY
```

And we can set up the KV secrets engine:

```sh
jq -r ".root_token" cluster-keys.json    # outputs the root token; needed for logging in.
kubectl --namespace vault exec --stdin=true --tty=true vault-0 -- /bin/sh
```

```sh
vault login # enter the root token from above
vault secrets enable -path=secret kv-v2
```

We should allow access from Kubernetes:

```sh
vault auth enable kubernetes
vault write auth/kubernetes/config \
    kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
```

## Web Console

```sh
kubectl --namespace vault port-forward service/vault 8200:8200
```

Then browse to <http://localhost:8200>. Log in using the root token from earlier. Poke around.

----

## External Secrets Operator

https://external-secrets.io/v0.7.2/introduction/getting-started/

```sh
helm repo add external-secrets https://charts.external-secrets.io
helm install external-secrets \
   external-secrets/external-secrets \
    --namespace external-secrets \
    --create-namespace \
    --set installCRDs=true
```

## `secret-store.yaml`

Per-namespace.

```yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "http://vault.vault.svc.cluster.local:8200"
      path: "secret"
      # Version is the Vault KV secret engine version.
      # This can be either "v1" or "v2", defaults to "v2"
      version: "v2"
      auth:
        # points to a secret that contains a vault token
        # https://www.vaultproject.io/docs/auth/token
        tokenSecretRef:
          name: "vault-token"
          key: "token"
```

The server, "http://vault.vault.svc.cluster.local:8200", is `<service>.<namespace>.svc.cluster.local`.

Will fail with `InvalidProviderConfig`.

```sh
kubectl create secret generic vault-token --from-literal=token=$ROOT_TOKEN
```

Warning: don't actually use the root token in prod, but yolo (for now).

Created a secret with the web ui...

```sh
/ $ vault kv list secret
Keys
----
foo
```


```sh
/ $ vault kv get secret/foo
= Secret Path =
secret/data/foo

======= Metadata =======
Key                Value
---                -----
created_time       2023-02-06T20:17:18.283590693Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
my-value    s3cr3t
```


https://external-secrets.io/v0.7.2/introduction/getting-started/#option-1-install-from-chart-repository
https://external-secrets.io/v0.7.2/provider/hashicorp-vault/#example
