---
title: "Git on nginx"
date: 2022-01-27T19:36:00Z
tags: git nginx kubernetes
---

I want to play with [GitOps](https://www.gitops.tech/) on my k3s cluster (specifically ArgoCD). To do that, I'm going to need a local git server. Here's how I set one up.

## Create a namespace

Namespaces are good, so:

```
kubectl create namespace git
```



```
$ cat Dockerfile
FROM nginx:latest
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        git fcgiwrap
```


```
$ cat k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: git-nginx
  namespace: git
  labels:
    app.kubernetes.io/name: git-nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: git-nginx
  template:
    metadata:
      labels:
        app.kubernetes.io/name: git-nginx
    spec:
      containers:
      - name: git-nginx
        image: docker.k3s.differentpla.net/git-nginx
        imagePullPolicy: Always
        volumeMounts:
        - name: git-nginx-vol
          mountPath: /var/lib/git
      volumes:
      - name: git-nginx-vol
        persistentVolumeClaim:
          claimName: git-nginx-pvc
ubuntu@rpi401:~/Source/git$ cat k8s/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: git-nginx-pvc
  namespace: git
spec:
  storageClassName: longhorn
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi

ubuntu@rpi401:~/Source/git$ cat k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: git-nginx
  name: git-nginx
  namespace: git
spec:
  type: LoadBalancer
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: git-nginx
```


```
$ kubectl apply -f k8s/
```

Service selector is wrong. No route to host.

## How can we tell whether a service is bound to a pod?

`kubectl describe service my-service` lists endpoints. If there are none, then the service isn't backed by an app.

```
$ kubectl --namespace git describe service git-nginx
Name:                     git-nginx
Namespace:                git
Labels:                   app=git-nginx
Annotations:              <none>
Selector:                 app=git-nginx
Type:                     LoadBalancer
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       10.43.245.143
IPs:                      10.43.245.143
LoadBalancer Ingress:     192.168.28.13
Port:                     <unset>  80/TCP
TargetPort:               80/TCP
NodePort:                 <unset>  31469/TCP
Endpoints:                <none>
Session Affinity:         None
External Traffic Policy:  Cluster
Events:
  Type    Reason       Age    From                Message
  ----    ------       ----   ----                -------
  Normal  IPAllocated  9m39s  metallb-controller  Assigned IP "192.168.28.13"
```

Firefox, if it can't connect to port 80 as http, tries https on port 443, which is useful, but confusing.



## LoadBalancer (TODO)

exposed via [LoadBalancer]({% post_url 2021/2021-12-20-installing-metallb %})

## Configure DNS

I'm [using CoreDNS]({% post_url 2021/2021-12-29-coredns %}) for LoadBalancer services, so after assigning an IP address, the DNS entry needs to be added. This is done by editing the relevant ConfigMap:

```
kubectl --namespace k3s-dns edit configmap k3s-dns
```

It should look like this:

```
...
  NodeHosts: |
    192.168.28.11 nginx.k3s.differentpla.net
    192.168.28.12 docker.k3s.differentpla.net
    192.168.28.13 git.k3s.differentpla.net
...
```

## References

- <https://esc.sh/blog/setting-up-a-git-http-server-with-nginx/>
- <https://www.docker.com/blog/how-to-use-the-official-nginx-docker-image/>

## Gave up

Can't get fastcgi to work, and nginx isn't reading sites-enabled, so... /shrug.
